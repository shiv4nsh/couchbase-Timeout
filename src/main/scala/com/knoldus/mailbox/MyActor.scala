package com.knoldus.mailbox

import java.util.concurrent.TimeUnit

import akka.actor.Actor
import com.couchbase.client.java.Bucket
import com.couchbase.client.java.document.JsonDocument
import com.couchbase.client.java.document.json.JsonObject
import scala.concurrent.ExecutionContext.Implicits.global

import scala.concurrent.Future


class MyActor(bucket: Bucket) extends Actor {


  def receive = {

    case message =>
      val timestamp = System.currentTimeMillis()
      val TTL = TimeUnit.SECONDS.toSeconds(30).toInt
      val jsonString="""{"portFolioBalance":2135402.23,"totalStockValue":1207952.547599505,"lastWeekpercentageGain":-56.68099192800587,"defaultCurrency":"INR","docType":"portfolioBalance","stocksWithValue":[{"exchange":"lse","quantity":10,"stk":"SDL","totalPrice":4215.3318,"price":421.53318,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"BAJAJCORP","totalPrice":395.35,"price":395.35,"opType":"long"},{"exchange":"nse","quantity":20,"stk":"HINDOILEXP","totalPrice":593,"price":29.65,"opType":"long"},{"exchange":"nse","quantity":20,"stk":"MRPL","totalPrice":1206,"price":60.3,"opType":"long"},{"exchange":"nyse","quantity":1,"stk":"FXCM","totalPrice":681.13045,"price":681.13045,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"TATACOMM","totalPrice":745.2,"price":372.6,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"WELCORP","totalPrice":88.2,"price":88.2,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"MPSLTD","totalPrice":662.9,"price":662.9,"opType":"long"},{"exchange":"lse","quantity":10,"stk":"PVCS","totalPrice":78.4704,"price":7.84704,"opType":"long"},{"exchange":"lse","quantity":22,"stk":"PMO","totalPrice":534.08916,"price":24.27678,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"NEYVELILIG","totalPrice":70,"price":70,"opType":"long"},{"exchange":"lse","quantity":100,"stk":"RPO","totalPrice":333.4992,"price":3.334992,"opType":"long"},{"exchange":"nse","quantity":20,"stk":"SOTL","totalPrice":9444,"price":472.2,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"TTML","totalPrice":12.9,"price":6.45,"opType":"long"},{"exchange":"nyse","quantity":1,"stk":"AZO","totalPrice":47466.8311,"price":47466.8311,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"SIEMENS","totalPrice":1017.55,"price":1017.55,"opType":"long"},{"exchange":"nsdq","quantity":1,"stk":"MEMP","totalPrice":125.88325,"price":125.88325,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"VIVIMEDLAB","totalPrice":800,"price":400,"opType":"long"},{"exchange":"nyse","quantity":30,"stk":"WTW","totalPrice":22066.9935,"price":735.56645,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"MTNL","totalPrice":34.6,"price":17.3,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"AMTEKAUTO","totalPrice":32.2,"price":32.2,"opType":"long"},{"exchange":"lse","quantity":100,"stk":"TRB","totalPrice":2305.068,"price":23.05068,"opType":"long"},{"exchange":"lse","quantity":10,"stk":"KNOS","totalPrice":2008.3518,"price":200.83518,"opType":"long"},{"exchange":"lse","quantity":10,"stk":"EDP","totalPrice":637.572,"price":63.7572,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"CEATLTD","totalPrice":943.5,"price":943.5,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"NOCIL","totalPrice":43.8,"price":43.8,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"THOMASCOOK","totalPrice":399.9,"price":199.95,"opType":"long"},{"exchange":"nyse","quantity":21,"stk":"TCPI","totalPrice":1141.727055,"price":54.367955,"opType":"long"},{"exchange":"nyse","quantity":10,"stk":"MMM","totalPrice":105292.833,"price":10529.2833,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"JSWSTEEL","totalPrice":1019.8,"price":1019.8,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"BAJAJHIND","totalPrice":32.1,"price":16.05,"opType":"long"},{"exchange":"nyse","quantity":1,"stk":"OKE","totalPrice":1403.76835,"price":1403.76835,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"IDEA","totalPrice":198.3,"price":99.15000000000001,"opType":"long"},{"exchange":"lse","quantity":10,"stk":"IEH","totalPrice":343.308,"price":34.3308,"opType":"long"},{"exchange":"lse","quantity":10,"stk":"MGGT","totalPrice":3432.099119999999,"price":343.2099119999999,"opType":"long"},{"exchange":"nyse","quantity":1,"stk":"MBI","totalPrice":430.72485,"price":430.72485,"opType":"long"},{"exchange":"lse","quantity":150,"stk":"CCC","totalPrice":115866.45,"price":772.443,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"BHARTIARTL","totalPrice":621.2,"price":310.6,"opType":"long"},{"exchange":"nsdq","quantity":13,"stk":"TVIX","totalPrice":9889.6603,"price":760.7431,"opType":"long"},{"exchange":"lse","quantity":10,"stk":"SGE","totalPrice":5811.714,"price":581.1713999999999,"opType":"long"},{"exchange":"lse","quantity":10,"stk":"SIA","totalPrice":1537.5294,"price":153.75294,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"OIL","totalPrice":332.3,"price":332.3,"opType":"long"},{"exchange":"lse","quantity":20,"stk":"DNDL","totalPrice":3707.7264,"price":185.38632,"opType":"long"},{"exchange":"nse","quantity":10,"stk":"EICHERMOT","totalPrice":161356.552114505,"price":16135.6552114505,"opType":"short"},{"exchange":"nse","quantity":1,"stk":"GODREJIND","totalPrice":339.6,"price":339.6,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"BATAINDIA","totalPrice":471.65,"price":471.65,"opType":"long"},{"exchange":"lse","quantity":1075,"stk":"SPD","totalPrice":390777.6876,"price":363.514128,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"JUSTDIAL","totalPrice":506.4,"price":506.4,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"TATASTEEL","totalPrice":469.3,"price":234.65,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"RCF","totalPrice":40.2,"price":40.2,"opType":"long"},{"exchange":"lse","quantity":40,"stk":"DIA","totalPrice":15468.4776,"price":386.71194,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"MONSANTO","totalPrice":2066.9,"price":2066.9,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"NETWORK18","totalPrice":89.2,"price":44.6,"opType":"long"},{"exchange":"nyse","quantity":1,"stk":"NADL","totalPrice":112.27425,"price":112.27425,"opType":"long"},{"exchange":"nse","quantity":13,"stk":"CHENNPETRO","totalPrice":2190.5,"price":168.5,"opType":"long"},{"exchange":"sehk","quantity":8136,"stk":"3988","totalPrice":0,"price":0,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"NAVINFLUOR","totalPrice":1549,"price":1549,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"ZEELEARN","totalPrice":69.7,"price":34.85,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"EROSMEDIA","totalPrice":361.7,"price":180.85,"opType":"long"},{"exchange":"asx","quantity":2,"stk":"IIL","totalPrice":16.6383,"price":8.319149999999999,"opType":"long"},{"exchange":"lse","quantity":32,"stk":"MCRO","totalPrice":42374.016,"price":1324.188,"opType":"long"},{"exchange":"lse","quantity":1,"stk":"ASBE","totalPrice":58.85279999999999,"price":58.85279999999999,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"CANBK","totalPrice":184,"price":184,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"SUPPETRO","totalPrice":108.85,"price":108.85,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"JKTYRE","totalPrice":86.3,"price":86.3,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"PGHH","totalPrice":11804.4,"price":5902.2,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"ZEEL","totalPrice":761.9,"price":380.95,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"TREEHOUSE","totalPrice":243,"price":121.5,"opType":"long"},{"exchange":"sehk","quantity":100,"stk":"0045","totalPrice":0,"price":0,"opType":"long"},{"exchange":"sehk","quantity":20000,"stk":"6030","totalPrice":0,"price":0,"opType":"long"},{"exchange":"lse","quantity":100,"stk":"WIN","totalPrice":15767.646,"price":157.67646,"opType":"long"},{"exchange":"nse","quantity":10,"stk":"TRENT","totalPrice":14691.5,"price":1469.15,"opType":"long"},{"exchange":"lse","quantity":10,"stk":"FTC","totalPrice":52.96752000000001,"price":5.296752000000001,"opType":"long"},{"exchange":"lse","quantity":144,"stk":"CSRT","totalPrice":134819.99424,"price":936.24996,"opType":"long"},{"exchange":"lse","quantity":47,"stk":"CIU","totalPrice":9635.184239999999,"price":205.00392,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"AXISBANK","totalPrice":782.9,"price":391.45,"opType":"long"},{"exchange":"sehk","quantity":10000,"stk":"0261","totalPrice":0,"price":0,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"TECHM","totalPrice":879.8,"price":439.9,"opType":"long"},{"exchange":"nse","quantity":2,"stk":"RCOM","totalPrice":113,"price":56.5,"opType":"long"},{"exchange":"lse","quantity":220,"stk":"E2V","totalPrice":46179.8304,"price":209.90832,"opType":"long"},{"exchange":"nse","quantity":1,"stk":"HDIL","totalPrice":67.3,"price":67.3,"opType":"long"},{"exchange":"nyse","quantity":1,"stk":"XOM","totalPrice":5451.7654,"price":5451.7654,"opType":"long"}],"donought":[{"color":"#5d5e0f","name":"<span>Financials</span> <strong>69.0%</strong>","y":69},{"color":"#B4C931","name":"<span>Consumer Services</span> <strong>14.0%</strong>","y":14},{"color":"#1361C3","name":"<span>Technology</span> <strong>6.0%</strong>","y":6},{"color":"#5d5e0f","name":"<span>Consumer Goods</span> <strong>4.0%</strong>","y":4},{"color":"#B42D1C","name":"<span>Industrials</span> <strong>3.0%</strong>","y":3},{"color":"#67A87F","name":"<span>Health Care</span> <strong>3.0%</strong>","y":3},{"color":"#A72E9F","name":"<span>Oil & Gas</span> <strong>1.0%</strong>","y":1}],"totalCashBalance":927449.6813789043,"portfolioGain":-57.292,"userId":816,"timestamp":1454976000}"""
      val doc = JsonObject.create().put("message", jsonString)
      val result = Future(bucket.upsert(JsonDocument.create(s"msg::$timestamp:$message",TTL, doc), 100000, TimeUnit.MINUTES)) recover{
        case exc:Exception=> println(s"exc is : ${exc.printStackTrace}")
      }
      val retrievedResult=Future(bucket.get(s"msg::$timestamp:$message"))
      retrievedResult.map(a=> println("idStored:"+a.id()))
  }
}

